<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Index Card + Tissue Layers</title>
  <style>
    :root{
      --bg:#f7f7fb;
      --card:#ffffff;
      --ink:#0f172a;
      --muted:#64748b;
      --ring:#e2e8f0;
      --accent:#111827;
      --shadow: 0 10px 20px rgba(2,8,23,.08), 0 2px 6px rgba(2,8,23,.06);
    }
    *{box-sizing:border-box}
    html,body{margin:0;padding:0;height:100%;font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial}
    body{background:linear-gradient(180deg,#f8fafc, #ffffff);color:var(--ink)}
    .container{max-width:1200px;margin:0 auto;padding:24px}
    .grid{display:grid;grid-template-columns:1fr;gap:24px}
    @media(min-width:1100px){.grid{grid-template-columns:1fr 380px}}
    .panel{background:var(--card);border:1px solid var(--ring);border-radius:16px;box-shadow:var(--shadow)}
    .panel h2{margin:0;padding:16px 20px;border-bottom:1px solid var(--ring);font-size:18px}
    .panel .content{padding:16px 20px}
    .row{display:flex;gap:8px;align-items:center}
    .row + .row{margin-top:10px}
    label{font-size:12px;color:var(--muted);width:18px;text-align:right}
    input[type=text], .text{width:100%;padding:10px 12px;border:1px solid var(--ring);border-radius:10px;outline:none;font-size:14px}
    input[type=text]:focus{border-color:#2563eb;box-shadow:0 0 0 3px rgba(37,99,235,.12)}
    .btn{display:inline-flex;align-items:center;gap:8px;padding:10px 12px;border-radius:10px;border:1px solid var(--ring);background:#fff;cursor:pointer}
    .btn.primary{background:#111827;color:#fff;border-color:#111827}
    .btn.ghost{background:#fff}
    .btn.small{padding:6px 8px;font-size:12px}
    .btn:disabled{opacity:.5;cursor:not-allowed}
    .toolbar{display:flex;gap:8px;flex-wrap:wrap}
    .sep{height:1px;background:var(--ring);margin:12px 0}
    /* Canvas (index card) */
    .stage-wrap{display:flex;justify-content:center}
    .stage{position:relative;aspect-ratio:3/2;width:min(900px,100%);border:1px solid var(--ring);border-radius:20px;overflow:hidden;background:#fff;box-shadow:var(--shadow)}
    .ruled{background-image:repeating-linear-gradient(to bottom, transparent 0px, transparent 22px, rgba(0,0,0,0.06) 22px, rgba(0,0,0,0.06) 23px)}
    .header{position:absolute;inset:0 0 auto 0;padding:16px 20px 10px;background:linear-gradient(180deg,rgba(255,255,255,.9),transparent) }
    .title{border:none;background:transparent;font-weight:700;font-size:20px;width:70%;outline:none}
    .subtitle{border:none;background:transparent;font-size:13px;color:var(--muted);width:70%;outline:none}
    .base{position:absolute;inset:0;padding:24px 24px 24px 24px}
    .base-inner{display:grid;grid-template-rows:repeat(8,1fr);height:100%;margin-top:58px}
    .base .line-input{border:none;background:transparent;outline:none;width:100%;font-size:18px}
    .layer{position:absolute;inset:0;pointer-events:none;mix-blend-mode:multiply}
    .layer .layer-inner{position:absolute;inset:0;padding:24px;margin-top:58px}
    .layer .grid{display:grid;grid-template-rows:repeat(8,1fr);height:calc(100% - 58px)}
    .layer .textline{user-select:none}
    /* Layers list */
    .layer-card{border:1px solid var(--ring);border-radius:12px;padding:10px;margin-bottom:10px}
    .row-controls{display:flex;gap:6px;flex-wrap:wrap}
    .chip{display:inline-block;width:14px;height:14px;border-radius:50%;border:1px solid rgba(0,0,0,.1);margin-right:6px;vertical-align:middle}
    .hint{color:var(--muted);font-size:12px}
    .footer-note{font-size:12px;color:var(--muted)}
    .color-swatch{width:26px;height:26px;border-radius:50%;border:1px solid var(--ring);cursor:pointer}
    .swatches{display:flex;gap:8px;flex-wrap:wrap}
  </style>
</head>
<body>
  <div class="container">
    <div class="grid">
      <div class="panel">
        <h2>Online Index Card + Layers</h2>
        <div class="content">
          <div class="toolbar" style="justify-content:space-between;margin-bottom:12px">
            <div class="toolbar">
              <button class="btn primary" id="btnAddLayer">+ New Layer</button>
              <button class="btn" id="btnExport">Export PNG</button>
            </div>
            <div class="hint">Type on the base card, then stack translucent “tissue” layers over it.</div>
          </div>
          <div class="stage-wrap">
            <div class="stage ruled" id="stage">
              <div class="header">
                <input id="title" class="title" placeholder="Card Title" value="My Story Card"/>
                <br/>
                <input id="subtitle" class="subtitle" placeholder="Optional subtitle" value="Add notes on layers like tissue paper ✨"/>
              </div>
              <div class="base">
                <div class="base-inner">
                  <input class="line-input" placeholder="Base line 1"/>
                  <input class="line-input" placeholder="Base line 2"/>
                  <input class="line-input" placeholder="Base line 3"/>
                  <input class="line-input" placeholder="Base line 4"/>
                  <input class="line-input" placeholder="Base line 5"/>
                  <input class="line-input" placeholder="Base line 6"/>
                  <input class="line-input" placeholder="Base line 7"/>
                  <input class="line-input" placeholder="Base line 8"/>
                </div>
              </div>
              <!-- Dynamic layers render here -->
              <div id="layersMount"></div>
            </div>
          </div>
        </div>
      </div>
      <div class="panel">
        <h2>Editor</h2>
        <div class="content">
          <div class="hint" style="margin-bottom:8px">Create layers, edit their text (8 lines), opacity, tint, font size, vertical offset, order, and visibility.</div>
          <div id="layersList"></div>
          <div class="sep"></div>
          <div class="footer-note">
            Tips:
            <ul>
              <li>Use <b>Up/Down</b> to reorder stacked tissue.</li>
              <li>Toggle <b>Show/Hide</b> to compare context.</li>
              <li><b>Export PNG</b> captures the current composition.</li>
            </ul>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- html2canvas for exporting -->
  <script src="https://unpkg.com/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
  <script>
    // --- State ---
    const palette = ["#fef3c7","#e0f2fe","#fce7f3","#dcfce7","#ede9fe","#f1f5f9"];
    const state = {
      layers: [],
      selectedLayerId: null
    };
    const uid = () => Math.random().toString(36).slice(2,9);

    // --- DOM refs ---
    const stageEl = document.getElementById('stage');
    const layersMount = document.getElementById('layersMount');
    const layersList = document.getElementById('layersList');
    const btnAddLayer = document.getElementById('btnAddLayer');
    const btnExport = document.getElementById('btnExport');

    // --- Init ---
    btnAddLayer.addEventListener('click', addLayer);
    btnExport.addEventListener('click', exportPNG);

    function addLayer(){
      const id = uid();
      const layer = {
        id,
        name: `Layer ${state.layers.length+1}`,
        lines: Array.from({length:8},()=>''),
        opacity: 0.7,
        color: palette[(state.layers.length % palette.length)],
        visible: true,
        italic: true,
        size: 18,
        offsetY: 0
      };
      state.layers.push(layer);
      state.selectedLayerId = id;
      render();
    }

    function removeLayer(id){
      const idx = state.layers.findIndex(l=>l.id===id);
      if(idx>-1){ state.layers.splice(idx,1); }
      if(state.selectedLayerId===id){ state.selectedLayerId = null; }
      render();
    }

    function duplicateLayer(id){
      const src = state.layers.find(l=>l.id===id);
      if(!src) return;
      const copy = JSON.parse(JSON.stringify(src));
      copy.id = uid();
      copy.name = src.name + ' (copy)';
      state.layers.push(copy);
      state.selectedLayerId = copy.id;
      render();
    }

    function moveLayer(id,dir){
      const idx = state.layers.findIndex(l=>l.id===id);
      if(idx<0) return;
      const newIdx = Math.max(0, Math.min(state.layers.length-1, idx+dir));
      if(newIdx===idx) return;
      const [item] = state.layers.splice(idx,1);
      state.layers.splice(newIdx,0,item);
      render();
    }

    function updateLayer(id, partial){
      const layer = state.layers.find(l=>l.id===id);
      if(!layer) return;
      Object.assign(layer, partial);
      render();
    }

    function updateLayerLine(id, i, text){
      const layer = state.layers.find(l=>l.id===id);
      if(!layer) return;
      layer.lines[i] = text;
      // Only re-render text of that layer for perf
      renderLayers();
    }

    function selectLayer(id){
      state.selectedLayerId = id;
      render();
    }

    // --- Rendering ---
    function render(){
      renderLayers();
      renderLayerList();
    }

    function renderLayers(){
      // Clear\n      layersMount.innerHTML = '';

      state.layers.forEach(layer=>{
        if(!layer.visible) return;
        const layerEl = document.createElement('div');
        layerEl.className = 'layer';
        layerEl.style.backgroundColor = layer.color;
        layerEl.style.opacity = layer.opacity;
        const inner = document.createElement('div');
        inner.className = 'layer-inner';
        inner.style.transform = `translateY(${layer.offsetY}px)`;

        const grid = document.createElement('div');
        grid.className = 'grid';
        grid.style.gridTemplateColumns = '1fr';
        grid.style.gridTemplateRows = 'repeat(8,1fr)';
        grid.style.height = '100%';

        for(let i=0;i<8;i++){
          const row = document.createElement('div');
          row.style.display='flex';
          row.style.alignItems='center';
          const span = document.createElement('div');
          span.className = 'textline';
          span.style.fontStyle = layer.italic ? 'italic' : 'normal';
          span.style.fontSize = layer.size + 'px';
          span.textContent = layer.lines[i] || '';
          row.appendChild(span);
          grid.appendChild(row);
        }
        inner.appendChild(grid);
        layerEl.appendChild(inner);
        layersMount.appendChild(layerEl);
      });
    }

    function el(tag, attrs={}, children=[]){
      const node = document.createElement(tag);
      for(const k in attrs){
        if(k==='class') node.className = attrs[k];
        else if(k==='style') Object.assign(node.style, attrs[k]);
        else if(k.startsWith('on') && typeof attrs[k]==='function'){
          node.addEventListener(k.slice(2).toLowerCase(), attrs[k]);
        } else {
          node.setAttribute(k, attrs[k]);
        }
      }
      children.forEach(c => node.appendChild(c));
      return node;
    }

    function renderLayerList(){
      layersList.innerHTML = '';

      if(state.layers.length===0){
        layersList.appendChild(el('div', {class:'hint'}, [document.createTextNode('No layers yet. Click "New Layer" to place a tissue overlay.') ]));
        return;
      }

      state.layers.forEach((layer, index)=>{
        const card = el('div',{class:'layer-card'});

        // Header row (name + controls)
        const nameRow = el('div',{class:'row', style:{justifyContent:'space-between'}});
        const left = el('div',{class:'row'});
        const dot = el('span',{class:'chip', style:{backgroundColor:layer.color}},[]);
        const nameInput = el('input',{type:'text', value:layer.name, class:'text', style:{maxWidth:'220px'}},[]);
        nameInput.addEventListener('input', e=> updateLayer(layer.id,{name:e.target.value}));
        left.appendChild(dot); left.appendChild(nameInput);

        const controls = el('div',{class:'row-controls'},[
          button('Edit Text', ()=>selectLayer(layer.id)),
          button('Duplicate', ()=>duplicateLayer(layer.id)),
          button('Delete', ()=>removeLayer(layer.id)),
          button('Up', ()=>moveLayer(layer.id,-1)),
          button('Down', ()=>moveLayer(layer.id,1)),
          button(layer.visible?'Hide':'Show', ()=>updateLayer(layer.id,{visible:!layer.visible}))
        ]);
        nameRow.appendChild(left);
        nameRow.appendChild(controls);
        card.appendChild(nameRow);

        // Sliders + toggles
        const sliders = el('div',{class:'row', style:{gap:'16px', marginTop:'10px', flexWrap:'wrap'}});
        sliders.appendChild(smallControl('Opacity', range(layer.opacity,0,1,0.01,(v)=>updateLayer(layer.id,{opacity:parseFloat(v)}))));
        sliders.appendChild(smallControl('Font', range(layer.size,12,28,1,(v)=>updateLayer(layer.id,{size:parseInt(v)}))));
        sliders.appendChild(smallControl('OffsetY', range(layer.offsetY,-20,20,1,(v)=>updateLayer(layer.id,{offsetY:parseInt(v)}))));
        sliders.appendChild(smallControl('Italic', checkbox(layer.italic,(v)=>updateLayer(layer.id,{italic:v}))));
        card.appendChild(sliders);

        // Color swatches
        const swatchWrap = el('div', {style:{marginTop:'8px'}});
        const sw = el('div',{class:'swatches'});
        palette.forEach(c=>{
          const b = el('div',{class:'color-swatch', style:{backgroundColor:c, outline: layer.color===c? '2px solid #111827':'none'}});
          b.addEventListener('click',()=>updateLayer(layer.id,{color:c}));
          sw.appendChild(b);
        });
        swatchWrap.appendChild(sw);
        card.appendChild(swatchWrap);

        // Text inputs for 8 overlay lines (only when selected)
        if(state.selectedLayerId === layer.id){
          card.appendChild(el('div',{class:'sep'}));
          const linesBox = el('div',{});
          for(let i=0;i<8;i++){
            const r = el('div',{class:'row'});
            const lab = el('label',{},[]);
            lab.textContent = (i+1).toString();
            const inp = el('input',{type:'text',class:'text',placeholder:`Overlay line ${i+1}`, value:layer.lines[i] || ''},[]);
            inp.addEventListener('input', (e)=> updateLayerLine(layer.id,i,e.target.value));
            r.appendChild(lab); r.appendChild(inp);
            linesBox.appendChild(r);
          }
          card.appendChild(linesBox);
        }

        layersList.appendChild(card);
      });
    }

    function button(text, onClick){
      const b = el('button',{class:'btn small', type:'button'},[]);
      b.textContent = text;
      b.addEventListener('click', onClick);
      return b;
    }
    function range(value,min,max,step,onInput){
      const r = el('input',{type:'range', min, max, step, value});
      r.addEventListener('input', e=> onInput(e.target.value));
      return r;
    }
    function checkbox(checked,onChange){
      const c = el('input',{type:'checkbox'});
      c.checked = !!checked;
      c.addEventListener('change', e=> onChange(e.target.checked));
      return c;
    }
    function smallControl(labelText, controlEl){
      const wrap = el('div',{});
      const l = el('div',{class:'hint', style:{marginBottom:'4px'}},[]);
      l.textContent = labelText;
      wrap.appendChild(l);
      wrap.appendChild(controlEl);
      return wrap;
    }

    async function exportPNG(){
      const canvas = await html2canvas(stageEl, {backgroundColor:null, scale:2});
      const url = canvas.toDataURL('image/png');
      const a = document.createElement('a');
      const title = (document.getElementById('title').value || 'index-card').replace(/\\s+/g,'-');
      a.href = url;
      a.download = title + '.png';
      a.click();
    }

    // initial render (no layers yet)
    render();
  </script>
</body>
</html>
